<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- LAYOUT RESET --- */
        * { box-sizing: border-box; }

        body {
            margin: 0;
            height: 100vh; 
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            overflow: hidden; 
            display: flex;
            flex-direction: column; 
        }

        /* --- 1. THE FIXED HEADER --- */
        #sticky-header-group {
            flex: 0 0 auto; 
            background: #000;
            border-bottom: 1px solid #222;
            padding: 10px 20px;
            z-index: 50;
            position: relative; 
            display: flex;
            justify-content: center; 
            align-items: center;
            min-height: 100px; 
        }

        /* Number/Arrow in Top Right */
        #display {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%); 
            font-size: 80px; 
            font-weight: bold;
            user-select: none;
            line-height: 1;
            white-space: nowrap; 
            text-align: right;
            z-index: 20;
            text-shadow: 0 0 5px black;
        }

        /* --- CENTER CONTENT SWITCHER --- */
        
        /* A. The Text Header */
        #slideLabel {
            background: transparent;
            border-bottom: 1px solid #333; 
            color: #ddd;
            font-size: 30px; 
            outline: none;
            padding-bottom: 2px;
            min-width: 200px;
            max-width: 60%; 
            text-align: center; 
            transition: border-color 0.2s;
            cursor: text;
            display: block; 
        }
        #slideLabel:focus { border-bottom: 1px solid #fff; }

        /* B. The PDF Canvas */
        #pdf-render-container {
            display: none; 
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 30vh; 
            position: relative;
            transition: height 0.1s ease; 
        }

        canvas {
            max-height: 100%; 
            max-width: 80%;
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #no-pdf-msg {
            color: #444;
            font-style: italic;
            position: absolute;
            font-size: 14px;
        }

        /* --- 2. THE SCROLLING NOTES AREA --- */
        #notes-container {
            flex: 1; 
            position: relative;
            overflow: hidden; 
            display: flex;
            justify-content: center; 
            border-top: 1px solid #111;
        }

        #slideNotes {
            background: transparent;
            border: none;
            color: #aaa; 
            font-size: 18px; 
            text-align: left; 
            outline: none;
            font-family: 'Consolas', 'Courier New', monospace; 
            height: 100%; 
            width: 100%;
            max-width: 800px; 
            padding: 20px;
            overflow-y: auto; 
            white-space: pre-wrap; 
            line-height: 1.6;
        }
        
        #slideNotes::-webkit-scrollbar { width: 10px; }
        #slideNotes::-webkit-scrollbar-track { background: #111; }
        #slideNotes::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }
        #slideNotes::-webkit-scrollbar-thumb:hover { background: #555; }

        /* --- SETTINGS MENU --- */
        #menu-container { position: absolute; top: 10px; left: 10px; z-index: 100; }
        
        #gear-btn {
            background: transparent;
            color: #555;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        #gear-btn:hover { color: #fff; }

        #controls-panel {
            display: none;
            margin-top: 5px;
            background: #111;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            flex-direction: column;
            gap: 15px;
            width: 260px; /* Slightly wider for buttons */
        }
        #controls-panel.active { display: flex; }

        button.action-btn {
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            background: #000;
            color: #ddd;
            border: 1px solid #444;
            border-radius: 4px;
        }
        button.action-btn:hover { background: #222; }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; color: #888; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #888; }
        input[type=file] { font-size: 12px; color: #aaa; }
        
        #mode-status { color: #aaa; font-size: 12px; font-weight: bold; }
        #clear-data-btn { color: #ff4444; border-color: #552222; }

    </style>
</head>
<body>

    <div id="menu-container">
        <button id="gear-btn" onclick="toggleMenu()">⚙</button>
        <div id="controls-panel">
            
            <div class="control-group">
                <div id="mode-status">Mode: Standard</div>
                <button class="action-btn" onclick="cycleMode()">Switch Mode</button>
            </div>
            
            <hr style="width:100%; border:0; border-top:1px solid #333;">

            <div class="control-group">
                <label>Load Slides (PDF)</label>
                <input type="file" id="pdf-upload" accept=".pdf">
            </div>

            <div class="control-group">
                <label>Import Notes (JSON)</label>
                <input type="file" id="json-upload" accept=".json">
            </div>

            <div class="control-group">
                <button id="export-btn" class="action-btn" onclick="exportNotes()">Save/Export Notes</button>
            </div>

            <hr style="width:100%; border:0; border-top:1px solid #333;">

            <div class="control-group">
                <label>Number Size</label>
                <input type="range" min="20" max="120" value="80" oninput="updateNumberSize(this.value)">
            </div>

            <div class="control-group">
                <label>Text Size</label>
                <input type="range" min="12" max="60" value="18" oninput="updateTextSize(this.value)">
            </div>

            <div class="control-group">
                <label>PDF Preview Size</label>
                <input type="range" min="10" max="60" value="30" oninput="updatePdfSize(this.value)" onchange="refreshPdfResolution()">
            </div>

            <button id="clear-data-btn" class="action-btn" onclick="clearAllData()">Reset All</button>
        </div>
    </div>

    <div id="sticky-header-group">
        <div id="display">0</div>
        <span id="slideLabel" contenteditable="true" role="textbox" data-placeholder="Header..."></span>
        <div id="pdf-render-container">
            <div id="no-pdf-msg">Load PDF in Settings (⚙)</div>
            <canvas id="the-canvas"></canvas>
        </div>
    </div>

    <div id="notes-container">
        <div id="slideNotes" contenteditable="true" role="textbox" data-placeholder="Start typing notes..."></div>
    </div>

    <script>
        // --- DATA STORAGE ---
        // We still auto-save to local storage as a backup
        const savedData = localStorage.getItem('slideTrackerData_Project'); 
        let state = savedData ? JSON.parse(savedData) : { count: 0, memory: {} };

        const MODES = ['NUM', 'PULSE', 'PDF'];
        let currentModeIndex = 0; 
        
        let pdfDoc = null;
        let renderTask = null;

        const canvas = document.getElementById('the-canvas');
        const ctx = canvas.getContext('2d');
        const display = document.getElementById('display');
        const slideLabel = document.getElementById('slideLabel');
        const slideNotes = document.getElementById('slideNotes');
        const pdfContainer = document.getElementById('pdf-render-container');
        const noPdfMsg = document.getElementById('no-pdf-msg');
        const modeStatus = document.getElementById('mode-status');
        const controlsPanel = document.getElementById('controls-panel');
        let timeoutHandle = null;

        updateUIForMode();
        updateDisplay();

        function saveData() {
            localStorage.setItem('slideTrackerData_Project', JSON.stringify(state));
        }

        // --- EXPORT / IMPORT LOGIC (NEW) ---

        // 1. EXPORT
        function exportNotes() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            // Naming convention: notes_TIMESTAMP.json
            const date = new Date().toISOString().slice(0,10); 
            downloadAnchorNode.setAttribute("download", "lecture_notes_" + date + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // 2. IMPORT
        document.getElementById('json-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const loadedState = JSON.parse(event.target.result);
                    
                    // Simple validation
                    if (typeof loadedState.count !== 'number' || !loadedState.memory) {
                        alert("Invalid JSON file format.");
                        return;
                    }

                    // Apply state
                    state = loadedState;
                    saveData(); // Save to local storage immediately
                    updateDisplay();
                    
                    // If PDF is loaded, jump to the saved slide
                    if(pdfDoc && MODES[currentModeIndex] === 'PDF') {
                        renderPage(state.count + 1);
                    }
                    
                    alert("Notes loaded successfully!");
                    
                } catch(err) {
                    alert("Error reading JSON file.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        });


        // --- MODE LOGIC ---
        function cycleMode() {
            currentModeIndex = (currentModeIndex + 1) % MODES.length;
            updateUIForMode();
            if (MODES[currentModeIndex] === 'PDF' && pdfDoc) {
                renderPage(state.count + 1);
            }
        }

        function updateUIForMode() {
            const mode = MODES[currentModeIndex];
            if (mode === 'PDF') {
                slideLabel.style.display = 'none';
                pdfContainer.style.display = 'flex';
                modeStatus.textContent = "Mode: PDF Slides";
            } else {
                slideLabel.style.display = 'block';
                pdfContainer.style.display = 'none';
                modeStatus.textContent = (mode === 'NUM') ? "Mode: Standard" : "Mode: No Numbers";
            }
            if(timeoutHandle) { clearTimeout(timeoutHandle); timeoutHandle = null; }
            updateDisplay(); 
        }

        // --- PDF LOADING ---
        document.getElementById('pdf-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type === "application/pdf") {
                const fileReader = new FileReader();
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc_) {
                        pdfDoc = pdfDoc_;
                        noPdfMsg.style.display = "none";
                        // Auto Switch to PDF mode
                        if (MODES[currentModeIndex] !== 'PDF') {
                             // Optional: force switch or just stay put
                        }
                        if (MODES[currentModeIndex] === 'PDF') {
                            renderPage(state.count + 1);
                        }
                    });
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        // --- PDF RENDER ENGINE ---
        function renderPage(num) {
            if (renderTask) renderTask.cancel();

            if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;

            pdfDoc.getPage(num).then(function(page) {
                const containerHeight = pdfContainer.clientHeight;
                const unscaledViewport = page.getViewport({scale: 1});
                const scale = containerHeight / unscaledViewport.height;
                const viewport = page.getViewport({scale: scale});

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = { canvasContext: ctx, viewport: viewport };
                renderTask = page.render(renderContext);

                renderTask.promise.then(() => { renderTask = null; })
                .catch((err) => { if(err.name !== 'RenderingCancelledException') console.log(err); });
            });
        }

        // --- INPUT & NAV ---
        function handleInput() {
            state.memory[state.count] = {
                header: slideLabel.innerText, 
                notes: slideNotes.innerText
            };
            saveData();
        }
        slideLabel.addEventListener('input', handleInput);
        slideNotes.addEventListener('input', handleInput);
        
        slideLabel.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); slideLabel.blur(); }
        });

        function handleNav(direction) {
            const mode = MODES[currentModeIndex];

            if (direction === 'forward') {
                state.count++;
                if (mode === 'PULSE') triggerFlash(">>>");
            } 
            else if (direction === 'backward') {
                if (state.count > 0) {
                    state.count--;
                    if (mode === 'PULSE') triggerFlash("<<<");
                }
            }

            saveData();
            updateDisplay();

            if (mode === 'PDF' && pdfDoc) {
                renderPage(state.count + 1);
            }
        }

        function updateDisplay() {
            const mode = MODES[currentModeIndex];
            const data = state.memory[state.count] || {};

            if (mode !== 'PDF') slideLabel.innerText = data.header || "";
            slideNotes.innerText = data.notes || "";

            if (mode === 'NUM' || mode === 'PDF') {
                display.textContent = state.count;
                display.style.color = "white";
            } 
            else if (mode === 'PULSE') {
                if (!timeoutHandle) {
                    display.textContent = "---";
                    display.style.color = "#333";
                }
            }
        }

        function triggerFlash(symbol) {
            if (timeoutHandle) clearTimeout(timeoutHandle);
            display.textContent = symbol;
            display.style.color = "white"; 
            timeoutHandle = setTimeout(() => {
                display.textContent = "---";
                display.style.color = "#333"; 
                timeoutHandle = null;
            }, 500);
        }

        function toggleMenu() { controlsPanel.classList.toggle('active'); }
        function updateNumberSize(val) { display.style.fontSize = val + "px"; }
        function updateTextSize(val) {
            slideNotes.style.fontSize = val + "px";
            slideLabel.style.fontSize = (val * 1.5) + "px";
        }
        function updatePdfSize(val) { pdfContainer.style.height = val + "vh"; }
        function refreshPdfResolution() {
            if (MODES[currentModeIndex] === 'PDF' && pdfDoc) {
                renderPage(state.count + 1);
            }
        }

        function clearAllData() {
            if(confirm("Reset all notes?")) {
                state = { count: 0, memory: {} };
                saveData();
                updateDisplay();
                if(pdfDoc) renderPage(1);
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { document.activeElement.blur(); return; }
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'ArrowUp' || e.key === 'ArrowRight') { e.preventDefault(); handleNav('forward'); return; }
                if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') { e.preventDefault(); handleNav('backward'); return; }
            }
            if (document.activeElement === slideNotes) return;
            if (document.activeElement === slideLabel) {
                 if (['ArrowUp','ArrowDown'].includes(e.key)) {
                    e.preventDefault(); 
                    handleNav(e.key === 'ArrowUp' ? 'forward' : 'backward');
                 }
                 return;
            }
            if(e.key === 'ArrowUp' || e.key === 'ArrowRight') handleNav('forward');
            else if(e.key === 'ArrowDown' || e.key === 'ArrowLeft') handleNav('backward');
        });
    </script>
</body>
</html>